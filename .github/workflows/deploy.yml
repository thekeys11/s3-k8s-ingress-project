name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: my-eks-cluster
  HELM_RELEASE_NAME: s3-nginx-app

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' ||
      github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    environment:
      name: staging
      url: https://staging-s3-app.example.com
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --name ${{ env.EKS_CLUSTER_NAME }} \
          --region ${{ env.AWS_REGION }}
    
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.13.0'
    
    - name: Helm lint
      run: |
        helm lint ./helm-chart
    
    - name: Deploy with Helm
      run: |
        helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ./helm-chart \
          --namespace staging \
          --create-namespace \
          --set image.tag=${{ github.sha }} \
          --set s3.bucketName=${{ secrets.S3_BUCKET_NAME }} \
          --set aws.region=${{ env.AWS_REGION }} \
          --set aws.accountId=${{ secrets.AWS_ACCOUNT_ID }} \
          --set ingress.host=staging-s3-app.example.com \
          --set ingress.tls.certificateArn=${{ secrets.ACM_CERTIFICATE_ARN }} \
          --wait \
          --timeout 5m
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/${{ env.HELM_RELEASE_NAME }}-s3-nginx-ingress \
          -n staging \
          --timeout=5m
    
    - name: Run smoke tests
      run: |
        INGRESS_HOST=$(kubectl get ingress -n staging -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
        echo "Testing endpoint: https://$INGRESS_HOST/health"
        
        # Wait for ALB to be ready
        sleep 60
        
        # Test health endpoint
        curl -f -s -o /dev/null -w "%{http_code}" https://staging-s3-app.example.com/health || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://s3-app.example.com
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --name ${{ env.EKS_CLUSTER_NAME }} \
          --region ${{ env.AWS_REGION }}
    
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.13.0'
    
    - name: Deploy with Helm
      run: |
        helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ./helm-chart \
          --namespace production \
          --create-namespace \
          --set image.tag=${{ github.sha }} \
          --set s3.bucketName=${{ secrets.S3_BUCKET_NAME }} \
          --set aws.region=${{ env.AWS_REGION }} \
          --set aws.accountId=${{ secrets.AWS_ACCOUNT_ID }} \
          --set ingress.host=s3-app.example.com \
          --set ingress.tls.certificateArn=${{ secrets.ACM_CERTIFICATE_ARN }} \
          --set replicaCount=5 \
          --wait \
          --timeout 10m
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/${{ env.HELM_RELEASE_NAME }}-s3-nginx-ingress \
          -n production \
          --timeout=10m
    
    - name: Run production smoke tests
      run: |
        # Test health endpoint
        curl -f https://s3-app.example.com/health || exit 1
        
        # Test actual S3 content
        curl -f https://s3-app.example.com/test.html || exit 1
    
    - name: Send deployment notification
      if: always()
      run: |
        echo "Production deployment completed with status: ${{ job.status }}"
        # Add Slack/email notification here if needed
